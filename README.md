# pve-gpg-backup

This script manage encrypted backup of vm/ct

## Requirements
- Proxmox
- Usage of embedded backup system under GUI of Proxmox
- Bash
- OPTIONAL : differiential backups from [GitHub ayufan/pve-patches](https://github.com/ayufan/pve-patches)

## How it works

This script will be launched after each manual/auto backup.
From backups generated by Proxmox (vzdump), this script will create encrypted file backup (gpg) and the according sha512sum. This sha will help to easily check integrity of the gpg along all networks transferts.  
This script purge old backup when the threshold of backups' count is reached

If differential backups already installed, full and diff backup will be managed independently

Backup managed by Proxmox still managed by Proxmox

## Method
- Install this script where you want (i.e. : /usr/local/bin/pve-gpg-backup.sh )

- Add the script into vzdump.conf as the line below (change path accordiing where you installed this script)
`echo "script: /usr/local/bin/pve-postbackup.sh" >> /etc/vzdump.conf`

- configure this script (go to the 'const' part in the script)  

| key | value |
|-|-|
| GPG_KEYNAME | name of your public gpg key |
| STOCKAGE_DST | destination for your encrypted backup (can be a folder already mounted as a client NFS storage) |
| TAG_LOG | tag you will seem in logs |
| NB_MAX_FULL | number of full backups still remain |
| NB_MAX_DIFF |  number of differential backups still remain |
| TYPE_BACKUP_FULL | included tag in filename from full backup |
| TYPE_BACKUP_DIFF | included tag in filename from diff backup |
| DEBUG | =1 show only backup too old, =0 show and delete old backup |

- no restart needed.

## Uninstall
To uninstall, juste remove the according line in /etc/vzdump.conf and delete this script

## Usage

#### GPG : to manage gpg files generated by this script :
- check entropy on your machine  
`cat /proc/sys/kernel/random/entropy_avail`  
if lighter than 3000 choose another machine to generate your keys

- create keys  
`gpg --full-gen-key`

- export pub/priv keys and stock it to be able to decrypt  
`gpg --armor --output <pubkey filename> --export '<key name>'`  
`gpg --armor --output <privkey filename> --export-secret-key '<key name>'`  

- remove priv-key  
`gpg --delete-secret-keys <name>`

#### GPG extract (when you need) :
- import the key  
`gpg --import <privkey filename>`

- decrypt the file  
 `gpg --decrypt <backup>.gpg`

#### sha512sum (auto generated for each gpg file) :  
- to check integrity of files through multiple transfert, test in the same folder as backup and this sah512  
`sha512sum <backup>.gpg.sha512`

## Author
PiDroid-B, 2019

## Warning
Try it on a test VM before use it for the other VM.  
Use it at your own risk. The author assumes no responsibility for all usage or error that result from this script.

## Licence
This project is licensed under the GPL v3 License. See the [LICENSE](https://github.com/PiDroid-B/pve-add-vmdk/blob/master/LICENSE) file for the full license text.

## Changelog

| version | release | date | description |
|-|-|-|-|
| 1.0.0 | | 2019-06-29 | Init |
| 1.0.1 | | 2019-06-30 | Remove unsed variables |
